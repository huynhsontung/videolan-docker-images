# Autogenerated by ./gen-dockerfile.sh  You don't want to edit it, and all changes will be lost.
#
FROM registry.videolan.org:5000/videolan-base-bionic:20180605113924
 
ENV IMAGE_DATE=201807191635

RUN apt-get update -qq && apt-get install -qqy \
    git wget bzip2 file unzip libtool pkg-config cmake build-essential \
    automake yasm gettext autopoint vim python git-svn ninja-build libwine-dev \
    flex ragel bison nasm zip dos2unix p7zip-full && \
    echo "deb http://archive.ubuntu.com/ubuntu cosmic universe" > /etc/apt/sources.list.d/cosmic.list && \
    apt update -qq && apt install -y -t cosmic nsis && \
    rm /etc/apt/sources.list.d/cosmic.list && \
    apt-get clean -y && \
    rm -rf /var/lib/apt/lists/*

# Disable statx for the time being to fix Qt build
# https://bugreports.qt.io/browse/QTBUG-64490
RUN for f in /usr/include/sys/syscall.h /usr/include/$(gcc -print-multiarch)/sys/syscall.h; do \
    if [ -f $f ]; then \
      echo "#undef SYS_statx" >> $f; \
    fi; \
done


RUN git config --global user.name "LLVM MinGW" && \
    git config --global user.email root@localhost

WORKDIR /build

ARG CORES=4

ENV TOOLCHAIN_PREFIX=/opt/llvm-mingw
ENV TOOLCHAIN_ARCHS="i686 x86_64 armv7 aarch64"


# Build everything and clean up, in one step
COPY *.sh ./
COPY wrappers/*.sh ./wrappers/
RUN ./build-all.sh $TOOLCHAIN_PREFIX && \
    ./strip-llvm.sh $TOOLCHAIN_PREFIX && \
    apt-get update -qq && \
    apt-get install -qqy binutils-mingw-w64-x86-64 && \
    cp /usr/bin/x86_64-w64-mingw32-windres $TOOLCHAIN_PREFIX/bin/x86_64-w64-mingw32-windresreal && \
    apt-get remove -qqy binutils-mingw-w64-x86-64 && \
    apt-get clean -y && \
    rm -rf /var/lib/apt/lists/* && \
    rm -rf /build

ENV PATH=$TOOLCHAIN_PREFIX/bin:$PATH
