From 1ee0c9868f1c1a1c45de4cf80eee2881507ab37e Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Hugo=20Beauz=C3=A9e-Luyssen?= <hugo@beauzee.fr>
Date: Tue, 6 Sep 2016 16:06:12 +0200
Subject: [PATCH 6/9] winstorecompat: Add GetConsoleOutputCP replacement

---
 mingw-w64-headers/include/wincon.h                 |  4 +++
 mingw-w64-libraries/winstorecompat/Makefile.am     |  1 +
 .../winstorecompat/src/GetConsoleOutputCP.c        | 38 ++++++++++++++++++++++
 3 files changed, 43 insertions(+)
 create mode 100644 mingw-w64-libraries/winstorecompat/src/GetConsoleOutputCP.c

diff --git a/mingw-w64-headers/include/wincon.h b/mingw-w64-headers/include/wincon.h
index 2993313..e239f1f 100644
--- a/mingw-w64-headers/include/wincon.h
+++ b/mingw-w64-headers/include/wincon.h
@@ -375,6 +375,10 @@ WINBASEAPI WINBOOL WINAPI SetCurrentConsoleFontEx(
 
 #endif /* WINAPI_FAMILY_PARTITION(WINAPI_PARTITION_DESKTOP) */
 
+#if WINAPI_FAMILY_PARTITION(WINAPI_PARTITION_APP) && defined(WINSTORECOMPAT)
+WINBASEAPI UINT WINAPI GetConsoleOutputCP(VOID);
+#endif
+
 #ifdef __cplusplus
 }
 #endif
diff --git a/mingw-w64-libraries/winstorecompat/Makefile.am b/mingw-w64-libraries/winstorecompat/Makefile.am
index 81512ce..ac69bb7 100644
--- a/mingw-w64-libraries/winstorecompat/Makefile.am
+++ b/mingw-w64-libraries/winstorecompat/Makefile.am
@@ -37,4 +37,5 @@ libwinstorecompat_a_SOURCES = \
   src/QueueTimer.c \
   src/Crypto.c \
   src/GetStartupInfo.c \
+  src/GetConsoleOutputCP.c \
   $(NULL)
diff --git a/mingw-w64-libraries/winstorecompat/src/GetConsoleOutputCP.c b/mingw-w64-libraries/winstorecompat/src/GetConsoleOutputCP.c
new file mode 100644
index 0000000..4e60ec2
--- /dev/null
+++ b/mingw-w64-libraries/winstorecompat/src/GetConsoleOutputCP.c
@@ -0,0 +1,38 @@
+/*
+    Copyright (c) 2013-2016 mingw-w64 project
+
+    Contributing authors: Hugo Beauz√©e-Luyssen
+
+    Permission is hereby granted, free of charge, to any person obtaining a
+    copy of this software and associated documentation files (the "Software"),
+    to deal in the Software without restriction, including without limitation
+    the rights to use, copy, modify, merge, publish, distribute, sublicense,
+    and/or sell copies of the Software, and to permit persons to whom the
+    Software is furnished to do so, subject to the following conditions:
+
+    The above copyright notice and this permission notice shall be included in
+    all copies or substantial portions of the Software.
+
+    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
+    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
+    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
+    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
+    DEALINGS IN THE SOFTWARE.
+*/
+
+#define GetConsoleOutputCP __GetConsoleOutputCP
+#include <windows.h>
+#undef GetConsoleOutputCP
+
+UINT GetConsoleOutputCP(void)
+{
+    return CP_UTF8;
+}
+
+#ifndef _WIN64
+UINT (*__MINGW_IMP_SYMBOL(GetConsoleOutputCP))(void) asm("__imp__GetConsoleOutputCP") = GetConsoleOutputCP;
+#else
+UINT (*__MINGW_IMP_SYMBOL(GetConsoleOutputCP))(void) asm("__imp_GetConsoleOutputCP") = GetConsoleOutputCP;
+#endif
-- 
2.9.3

